#!/bin/bash

echo "üîê Setting up GPG and SSH keys..."

# Import GPG key if it exists
if [ -f "$HOME/gpg-private-key.asc" ]; then
    echo "üîê Importing GPG key..."
    gpg --import "$HOME/gpg-private-key.asc" 2>/dev/null || echo "‚ö†Ô∏è  GPG key may already be imported"
    
    # Set trust level
    echo "Setting ultimate trust for GPG key..."
    echo -e "5\ny\n" | gpg --command-fd 0 --edit-key 5D4FE959DA79B3649B53D852C668C68A73B6A7B9 trust quit 2>/dev/null || true
    
    echo "‚ö†Ô∏è  Remember to delete ~/gpg-private-key.asc manually after verifying import"
    echo "‚úÖ GPG key imported successfully"
else
    echo "‚ö†Ô∏è  GPG key not found at ~/gpg-private-key.asc - skipping import"
fi

# Setup SSH keys permissions
if [ -d "$HOME/.ssh" ]; then
    echo "üîë Setting SSH key permissions..."
    chmod 700 ~/.ssh
    find ~/.ssh -type f -name "id_*" ! -name "*.pub" -exec chmod 600 {} \; 2>/dev/null || true
    find ~/.ssh -type f -name "*.pub" -exec chmod 644 {} \; 2>/dev/null || true
    [ -f ~/.ssh/config ] && chmod 600 ~/.ssh/config
fi

# Start ssh-agent and add keys
if command -v ssh-agent &> /dev/null; then
    echo "üîë Adding SSH keys to ssh-agent..."
    eval "$(ssh-agent -s)" 2>/dev/null || true
    
    # Add all private keys found
    find ~/.ssh -type f -name "id_*" ! -name "*.pub" -exec ssh-add {} \; 2>/dev/null || true
fi

# Configure GPG agent for better UX
if [ ! -f "$HOME/.gnupg/gpg-agent.conf" ]; then
    echo "‚öôÔ∏è  Configuring GPG agent..."
    mkdir -p "$HOME/.gnupg"
    cat > "$HOME/.gnupg/gpg-agent.conf" << 'EOF'
default-cache-ttl 34560000
max-cache-ttl 34560000
pinentry-program /opt/homebrew/bin/pinentry-mac
EOF
    gpgconf --kill gpg-agent 2>/dev/null || true
fi

echo ""
echo "‚úÖ GPG and SSH setup complete!"
echo ""
echo "üìù Verify:"
echo "  gpg --list-keys"
echo "  ssh -T git@github.com"
echo "  ssh-add -l"


# Switch Self to SSH for future operations
echo ""
echo "üîÑ Switching dotfiles remote to SSH..."
chezmoi git remote set-url origin git@github.com:josesolisrosales/dotfiles.git

echo -e "‚úÖ Remote switched to SSH${NC}"

if [ ! -d "$HOME/.config/nvim/.git" ]; then
    echo "üì¶ Cloning nvim config..."
    git clone https://github.com/josesolisrosales/josesolisrosales.nvim.git ~/.config/nvim
    echo -e "‚úÖ Neovim config cloned${NC}"
else
    echo -e "‚úÖ Neovim config already exists${NC}"
fi

# Clone iTerm2 profiles if not exists
if [ ! -d "$HOME/.iterm-settings/.git" ]; then
    echo "üì¶ Cloning iTerm2 settings..."
    git clone git@github.com:josesolisrosales/iterm-settings.git ~/.iterm-settings
    echo -e "‚úÖ iTerm2 settings cloned${NC}"
else
    echo -e "‚úÖ iTerm2 settings already exists${NC}"
fi

# Configure iTerm2 to use custom profiles directory
if [ -d "$HOME/.iterm-settings" ]; then
    echo "‚öôÔ∏è  Configuring iTerm2..."
    defaults write com.googlecode.iterm2 PrefsCustomFolder -string "$HOME/.iterm-settings"
    defaults write com.googlecode.iterm2 LoadPrefsFromCustomFolder -bool true
    defaults write com.googlecode.iterm2 NoSyncNeverRemindPrefsChangesLostForFile -bool true
    defaults write com.googlecode.iterm2 NoSyncNeverRemindPrefsChangesLostForFile_selection -int 0
    echo -e "${GREEN}‚úì iTerm2 configured to use ~/.iterm-settings${NC}"
    echo "   Note: Changes take effect after restarting iTerm2"
else
    echo -e "${YELLOW}‚ö†Ô∏è  iTerm2 profiles directory not found${NC}"
fi
