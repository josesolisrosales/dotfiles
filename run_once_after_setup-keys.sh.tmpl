#!/bin/bash

echo "ğŸ” Setting up GPG and SSH keys..."

# Import GPG key if it exists
if [ -f "$HOME/gpg-private-key.asc" ]; then
    echo "ğŸ” Importing GPG key..."
    gpg --import "$HOME/gpg-private-key.asc" 2>/dev/null || echo "âš ï¸  GPG key may already be imported"
    
    # Set trust level
    echo "Setting ultimate trust for GPG key..."
    echo -e "5\ny\n" | gpg --command-fd 0 --edit-key 5D4FE959DA79B3649B53D852C668C68A73B6A7B9 trust quit 2>/dev/null || true
    
    echo "âš ï¸  Remember to delete ~/gpg-private-key.asc manually after verifying import"
    echo "âœ… GPG key imported successfully"
else
    echo "âš ï¸  GPG key not found at ~/gpg-private-key.asc - skipping import"
fi

# Setup SSH keys permissions
if [ -d "$HOME/.ssh" ]; then
    echo "ğŸ”‘ Setting SSH key permissions..."
    chmod 700 ~/.ssh
    find ~/.ssh -type f -name "id_*" ! -name "*.pub" -exec chmod 600 {} \; 2>/dev/null || true
    find ~/.ssh -type f -name "*.pub" -exec chmod 644 {} \; 2>/dev/null || true
    [ -f ~/.ssh/config ] && chmod 600 ~/.ssh/config
fi

# Start ssh-agent and add keys
if command -v ssh-agent &> /dev/null; then
    echo "ğŸ”‘ Adding SSH keys to ssh-agent..."
    eval "$(ssh-agent -s)" 2>/dev/null || true
    
    # Add all private keys found
    find ~/.ssh -type f -name "id_*" ! -name "*.pub" -exec ssh-add {} \; 2>/dev/null || true
fi

# Configure GPG agent for better UX
if [ ! -f "$HOME/.gnupg/gpg-agent.conf" ]; then
    echo "âš™ï¸  Configuring GPG agent..."
    mkdir -p "$HOME/.gnupg"
    cat > "$HOME/.gnupg/gpg-agent.conf" << 'EOF'
default-cache-ttl 34560000
max-cache-ttl 34560000
pinentry-program /opt/homebrew/bin/pinentry-mac
EOF
    gpgconf --kill gpg-agent 2>/dev/null || true
fi

echo ""
echo "âœ… GPG and SSH setup complete!"
echo ""
echo "ğŸ“ Verify:"
echo "  gpg --list-keys"
echo "  ssh -T git@github.com"
echo "  ssh-add -l"


# Switch Self to SSH for future operations
echo ""
echo "ğŸ”„ Switching dotfiles remote to SSH..."
chezmoi git remote set-url origin git@github.com:josesolisrosales/dotfiles.git

echo -e "âœ… Remote switched to SSH${NC}"

if [ ! -d "$HOME/.config/nvim/.git" ]; then
    echo "ğŸ“¦ Cloning nvim config..."
    git clone https://github.com/josesolisrosales/josesolisrosales.nvim.git ~/.config/nvim
    echo -e "âœ… Neovim config cloned${NC}"
else
    echo -e "âœ… Neovim config already exists${NC}"
fi

# Clone iTerm2 profiles if not exists
if [ ! -d "$HOME/.iterm-settings/.git" ]; then
    echo "ğŸ“¦ Cloning iTerm2 settings..."
    git clone git@github.com:josesolisrosales/iterm-settings.git ~/.iterm-settings
    echo -e "âœ… iTerm2 settings cloned${NC}"
else
    echo -e "âœ… iTerm2 settings already exists${NC}"
fi
