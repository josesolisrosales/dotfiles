#!/bin/bash

set -e  # Exit on error

echo "ğŸš€ Starting system setup..."

# Install Homebrew if not present
if ! command -v brew &> /dev/null; then
    echo "ğŸ“¦ Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Add Homebrew to PATH for Apple Silicon
    if [[ $(uname -m) == 'arm64' ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
fi

# Update Homebrew
echo "ğŸ“¦ Updating Homebrew..."
brew update || true

# Install essential Homebrew packages (continue on error)
echo "ğŸ“¦ Installing Homebrew packages..."
PACKAGES=(
    act
    bash
    chezmoi
    conftest
    dialog
    docker
    ffmpeg
    gawk
    gnu-sed
    gnu-tar
    gnupg
    guile
    htop
    ipcalc
    iperf
    keyring
    make
    markdownlint-cli
    openshift-cli
    openssl@1.1
    pinentry-mac
    qemu
    qpdf
    rtmpdump
    sshuttle
    telnet
    tree
    trufflehog
    watch
    wget
    wimlib
    ykman
    zsh-autosuggestions
    age
)

for package in "${PACKAGES[@]}"; do
    if brew list "$package" &>/dev/null; then
        echo "âœ“ $package already installed"
    else
        echo "Installing $package..."
        brew install "$package" || echo "âš ï¸  Failed to install $package, continuing..."
    fi
done

# Install Warp Terminal
echo "ğŸ’» Installing Warp Terminal..."
brew install --cask warp || echo "âš ï¸  Warp may already be installed or failed to install"

# Install mise
if ! command -v mise &> /dev/null; then
    echo "ğŸ”§ Installing mise..."
    curl https://mise.run | sh
    
    eval "$(~/.local/bin/mise activate zsh)" 2>/dev/null || true
fi

# Install Oh My Zsh if not present
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    echo "ğŸ’» Installing Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
fi

# Install mise tools
echo "ğŸ”§ Installing mise tools..."
mise install || echo "âš ï¸  Some mise tools may have failed to install"

echo ""
echo "âœ… Package installation complete!"
echo ""
echo "ğŸ“ Next steps will run automatically:"
echo "  - GPG key import"
echo "  - SSH key setup"
echo ""
